
import React, { useEffect } from 'react';
import { MapContainer, TileLayer, useMap } from 'react-leaflet';
import MarkerClusterGroup from 'react-leaflet-cluster';
import { useOltStore } from './oltStore';
import { dataService } from './services/dataService';
import { OLTMarker } from './components/OLTMarker';
import { SearchPanel } from './components/SearchPanel';
import { OLT } from './types';

// OLT raw data provided by user
const RAW_OLT_DATA = [
    {"ip_address":"10.160.1.3","site_name":"สค.สุราษฎร์ธานี","site_code":"sd-sdio","cat_office_name":"สค.สุราษฎร์ธานี","equ_type_name":"ol","DV_lat":9.134232778,"DV_lng":99.3289675,"enterprise_name":"HUAWEI","platform_chassis":"MA5603","power_consumption_watts":223,"pon_port":48,"pon_up":30,"pon_down":18,"cat_ids":"5030328107,SDNO09687037,SDNO09687040,SDNO09751145,5030011288,SDNO09332393,5030220893,5030278363,GDNO001650,GFRD12007,SDNO09604910,SDNO09604918,SDNO09604922,5030109009,5030312737,5030354688,SDNO09685793,5030134406,5030126810,5030401025,GOIC20057,SDNO09622799,5030133506,5030231985,5030302010,3050025277,SDNO09655263,5030122147,5030123770,5030165025,5030270763,5030278253,SDNO09643772,SDNO09725035,5030267480,5030120498,5030182413,5030272265,5030409892,5030027433,5030130849,SDNO09760660,5030063473,5030065282,5030068586,SDNO09684949,SDNO09690810,5030139080,5030145903,5030164996,5030205636,5030302666,5030329097,5030380114,SDNO09781854,5030039400,SDNO09708469,SDNO10686634,5030111381,5030119337,5030132819,5030210828,5030036058,5030312218,5030021463,BDNO00654983,SDNO09380454,5030120493,5030132282,5030197989,SDNO09759303,5030121511,5030240255,5030315869,GDNO00677954,SDNO09336189,5030123712,5030299498,5030353685,5030122712,5030127124,5030133395,5030171568,5030279477,5030333899,SDNO09363021,5030088695,SDNO09661382,5030104345,5030104767,5030116634,5030408550,5030408716,5030033458,SDNO09689196,5030168945,5030179285,5030234204,5030299548,5030315142,5030345144,5030362422,5030376968,5030127027,5030127066,5030127038,5030337006,SDNO09703672,5030099097,5030198439,5030276229,5030276185,5030358519,5030404687,SDNO09735417,SDNO09780458,5030400966,5030123761,5030268074,5030402628,5030402630,SDNO09741250,SDNO09744793,5030041050,SDNO09687659,5030145248,5030363992,5030374726,5030039400,SDNO09756229,SDNO09663023,5030275206,5030314684,5030328798,5030387530,5030410378,5030416666,3050025283,5030056683,SDNO09661906,5030251073,5030305499,3050025284,SDNO09739571,SDNO09769569,SDNO09789623,5030178416,5030219281,SDNO09790236,5030122156,5030265394,5030300917,5030394886,5030160046,5030160047,5030163506,5030164306,5030351510,SDNO09744183,5030030788,5030172310,SDNO09641036,SDNO09688809,SDNO09718129,5030186876,5030349785,SDNO09749294,SDNO09749306,5030053609,5030122226,5030364008,5030013329,SDNO09759003,SDNO09715876,SDNO09719373,5030170182,5030226507,5030271285,5030312146,5030352908,5030000830,SDC602214,SDNO09669919,SDNO09682952,SDNO09751087,SDNO09776411,5030266032,5030239082,5030164270,SDNO09751097,SDNO09752771,5030139077,5030238789,SDNO09754154,5030006715,5030136718,5030102692,SDNO09755756,SDNO09767540,SDNO09319193,SDNO09360833,5030219890,5030304221,5030310361,5030310961,5030312563,5030340699,5030384291,SDNO09760482,5030054735,SDNO09712976,5030131740,5030337977,5030348443,SDNO09765445,BAXA144999,SDNO09710905,SDNO09717543,SDNO09717563,SDNO09722083,5030127024,SDNO09661871,SDNO09663927,SDNO09723615,5030123764,5030264132,5030327038,5030343833,5030356043,5030356842,5030381148,SDNO09771157,5030028449,3050002516,SDNO09659668,WDNO00645972,5030387782,SDNO09726828,5030095477,5030169778,5030357056,SDNO09772452,SDNO09315105,SDNO09636790,BDNO00770649,SDC125877,SDNO09687415,SDNO09688563,GFMIS746B,SDNO09691029,5030103908,5030130408,5030135517,5030061028,5030130004,5030130029,5030330090,5030383442,SDNO09743989,SDNO09601329,5030130033,5030124748,5030162172,5030171799,5030411589,SDNO09776301,SDNO09777902,5030009035,5030018582,5030029948,GDNO00773756,SDNO09688574,5030120402,5030120804,5030120805,5030275777,5030292492,5030318715,5030365763,5030375575,5030403672,5030413728,5030120673,5030129999,5030132685,5030125148,5030246297,5030415829,SDNO09789692,5030309729,SDC798230,5030012623,SDC799273,SDNO09654812,SDNO09785115,5030124709,5030241619,5030241707,5030323497,5030009619,5030032151,5030123465,5030120898,5030130795,5030140973,5030158445,5030231618,5030305875,5030331139,5030365564,5030408436,5030009571,SDNO0965493,SDNO09705122,5030120539,5030315471,5030361200,GSB086912,5030018743,5030124903,5030136027,5030411551,GMOC0011,5030072824,5030341226,5030393973,5030393974,5030393975,5030397867,SDNO09792887,5030146022,5030329935,5030416537,SDNO09643216,5030270762,5030300662,3020000373,5030357396,5030266039,5030124071,5030186932,5030249114,5030266670,5030414158,5030038358,5030026715,5030047097,SDNO09670665,SDNO09670882,5030284574,5030397994,5030041501,3050001443,305001941,3720001727,5030292413,5030376001,5030411218,5030020578,5030069696,5030011725,5030052614,SDNO09305934,SDNO09307978,SDNO09309754,SDNO09319169,SDNO09320744,SDNO09327502,SDNO09348908,SDNO09687662,SDNO09688703,SDNO09689100,5030092000,5030106171,5030155859,5030184626,SDC796961,5030284594,3050025285,GIN144589,SDNO09610827,5030130979,5030140020,5030120896,5030283306,5030398803,5030011362,5030318887,5030374397,5030050747,SDNO09728892,5030131525,5030183652,5030288692,5030293151,5030305936,5030328112,5030350048,5030391044,5030416448,5030050669,5030174217,5030246350,5030266678,5030309631,5030310737,5030333639,5030408244,BDN011257,SDNO09315983,5030139082,5030182502,5030256815,5030271284,5030403828,SDNO09682156,SDNO09693363,5030292001,5030370770,5030394514,5030065677,5030068651,GDNO00673663,SDNO09322000,BDNO004201,SDNO09688427,SDNO09715092,BDNO00754705,5030392577,5030120401,5030102035,5030122553,5030295002"},
    {"ip_address":"10.160.1.4","site_name":"ภูธร8","site_code":"sd-pt8s","cat_office_name":"สค.สุราษฎร์ธานี","equ_type_name":"ol","DV_lat":9.08405,"DV_lng":99.32648,"enterprise_name":"HUAWEI","platform_chassis":"MA5800-X2","power_consumption_watts":320,"pon_port":16,"pon_up":12,"pon_down":4,"cat_ids":"SDNO09737125,SDNO09747044,5030010699,5030122488,3050025274,5030180930,5030015994,5030133469,5030339970,5030384596,5030075743,5030261511,5030209130,5030320829,5030321440,5030331913,5030358388,5030133338,5030172405,5030127693,5030110047,5030161156,5030378043,5030394090,5030192903,5030133354,5030133382,5030127695,5030130902,5030131002,5030169212,5030064052,5030365736,5030301701,5030390155,5030408880,5030414336,5030326664,5030125738,5030171129,5030412493,5030067393,SDNO09740425,SDNO09744075,SDNO09752997,5030068259,5030112322,5030130269,5030257686,5030261472,5030186041,5030332970,SDNO09410495,3050022200,5030346686,5030358346,5030024482,GDNO001383,5030163508,5030171653,5030202529,GFMIS405M,GDI043891,5030025956,5030122578,5030138477,5030309509,5030326322"},
    {"ip_address":"10.160.1.5","site_name":"บางพลา","site_code":"sd-bplas","cat_office_name":"สค.สุราษฎร์ธานี","equ_type_name":"ol","DV_lat":9.18281,"DV_lng":99.2494,"enterprise_name":"HUAWEI","platform_chassis":"MA5608","power_consumption_watts":160,"pon_port":8,"pon_up":8,"pon_down":0,"cat_ids":"SDNO09779488,SDNO09797045,5030038464,5030014441,5030340051,3050025271,5030409431,SDNO09785027,SDNO09661924,SDNO09677514,5030282774,SDNO09734319,SDNO09745001,SDNO09789492,SDNO09728111,SDNO09728160,5030113016,5030182995,5030264367,5030309680,5030358450,SDNO09661364,5030186042,5030344934,5030016909,5030147306,GNFE002168,SDNO09757597,5030006290,5030014691,SDNO09660374,SDNO09660383,SDNO09660387,SDNO09661884,SDNO09663212,SDNO09340645,5030253782,SDNO09367740,5030204479,5030349136"},
    {"ip_address":"10.160.1.6","site_name":"สค.สุราษฎร์ธานี","site_code":"sd-sdio","cat_office_name":"สค.สุราษฎร์ธานี","equ_type_name":"ol","DV_lat":9.13423,"DV_lng":99.329,"enterprise_name":"HUAWEI","platform_chassis":"MA5603","power_consumption_watts":223,"pon_port":16,"pon_up":6,"pon_down":10,"cat_ids":"5030125739,5030131777,5030223966,SDNO09742606,5030383438,5030000403,5030247618,SDNO09777251,SDO778892,5030182394,SDNO09333345,5030149828,5030165622,SDNO09782508,5030186928,5030197289,5030359381,5030390026,SDNO09782526,5030010813,5030010341,5030082771,5030099653,5030220517,5030220518,5030222576,5030249504,5030309676,5030326650,5030335107,5030391098,5030081712,5030014378,5030187430,5030184477,5030238255,5030325344,5030388645,5030305168,5030035140,5030013983,5030018606,5030064395,5030064405,5030118479,5030345012,5030084677,5030050732,5030127696,5030131664,5030316974,5030339491,5030416388,SDNO09707662,5030090782,5030126050,5030309519,5030120643,5030130221,5030240260,3050025278"},
    {"ip_address":"10.160.1.8","site_name":"ในบาง","site_code":"sd-nbans","cat_office_name":"สค.สุราษฎร์ธานี","equ_type_name":"ol","DV_lat":9.1474,"DV_lng":99.3203,"enterprise_name":"HUAWEI","platform_chassis":"MA5608","power_consumption_watts":160,"pon_port":16,"pon_up":9,"pon_down":7,"cat_ids":"SDNO09718706,SDNO09726350,5030008840,SDNO09731685,SDNO09771861,SDNO09776076,SDNO09700027,SDNO09724417,5030120772,5030120774,5030120707,5030125731,5030127047,5030135710,5030222091,5030359774,5030391848,5030403916,5030306822,SDNO09788554,5030080860,5030135469,SDNO09779147,SDNO09742902,SDNO09779095,5030028801,SDNO09620743,SDNO09698211,5030222098,5030294041,5030305728,5030305867,5030313609,5030389031,5030392782,5030398351,5030025861,5030026447,5030204425,5030302118,5030307313,5030329284,5030034709,SDNO09724150,5030165718,5030226035,5030311277,5030312529,5030073902,SDNO09727471,5030084821,5030338754,SDNO09407466,SDNO09701878,5030090329,5030213364,SDNO09606451,SDNO09606467,SDNO09606481,SDNO09606482,SDNO09664291,5030096360,5030356323,SDNO09708308,5030283276,5030146543,5030348390,5030396282,5030395721"},
    {"ip_address":"10.160.100.2","site_name":"ควนมีด","site_code":"sk-knms","cat_office_name":"สค.หาดใหญ่","equ_type_name":"ol","DV_lat":6.98616,"DV_lng":100.6783,"enterprise_name":"HUAWEI","platform_chassis":"MA5608","power_consumption_watts":160,"pon_port":16,"pon_up":15,"pon_down":1,"cat_ids":"GNFE002262,SDNO12330572,SDNO12625932,5030127594,5030266924,5030377104,5030394887,5030399588,5030406263,SDNO12699534,5030259797,5030261461,5030322130,5030340863,5030352530,5030352534,5030357048,5030359095,5030359092,5030375088,SDNO12642336,SDNO12642357,SDNO12709344,5030280147,5030297406,5030297441,5030300691,5030357872,5030400863,5030050357,5030127591,5030163146,5030190171,5030255716,5030282487,5030289008,5030289384,5030289408,5030353820,5030358890,5030373396,5030405989,SDNO12757290,5030352825,SDNO12764318,5030307779,SDNO12778364,5030280148,5030342729,5030354767,5030362645,SDNO12780364,SDNO12778904,SDNO12715917,SDNO12715952,5030125450,5030127579,SDC715896,5050004671,5030353230,5030353477,5030391950,5030409411,SDNO12780331,SDNO12703517,5030128716,5030205386,SDNO12780278,5030093496,5030169783,5030208461,5030208471,5030226236,5030226226,5030226483,5030301509,5030309273,5030363346,5030371545,5030394229,SDNO12741065,SDNO12788861,SDNO12791329,SDNO12775365,SDNO12791309,5030272173,SDNO12780342,5030046569,5030193279,5030079437,5030079515,5030080721,5030087463,5030133992,5030161744,5030161758,5030167162,5030169906,5030171535,5030180875,5030196530,5030196612,5030205942,5030269160,5030360028,5030361254,5030379082,5030382776,5030038900,5030039653,SDNO12775875,5030051235,GDI123813,5030079610,5030079571,5030062896,5030334087,3050024954,5030409525,5030207396,5030104919,5030167540,5030273126,5030380014,GNFE002259,5030193880,5030080705,5030129739,5030177752,5030389603,5030389688,5030127597,5030135689,5030205341,5030303119,5030129705,5030129878,5030193790,5030222581,5030318971,5030322550,5030323636,5030335034,5030337281,5030368939,5030369818,5030374608,5030128792,5030133991,5030133971,5030133967,5030147450,5030147471,5030200977,5030302083,5030313022,5030313983,5030331985,5030332554,5030336153,5030338437,5030350888,5030126853,5030126863,5030266895,5030292939,5030292928,5030342234,5030127466,5030133888,5030129770,5030362632,5030134341,5030149404,5030134978,5030135086,5030177740,5030224755,5030224746,5030303735,5030317785,5030348799,5030134985,5030135020,5030135120,5030135061,5030134970,5030226454,5030228790,5030228791,5030229027,5030244573,5030307880,5030354656,5030364287,5030368950,5030394722,5030129692,5030136563,5030183490,5030265289,5030265288,5030265287,5030267353,5030320837,5030385154,5030385630,5030238090,5030238084,5030238071,5030298964,5030335593,5030369573,5030239209,5030263141,5030295785,5030317782,5030317780,5030318973,5030346150,5030366258,5030384124,5030405115,5030040815,SDNO12339077,5030242605,5030242517,5030242510,5030244572,5030245747,5030263125,5030361431,5030361934,5030375279,5030406786,5030242500,5030242462,5030245740,5030245735,5030254398,5030255717,5030288401,5030290561,5030290570,5030301445,5030326736,5030337894,5030344212,5030350547,5030350546,5030351940,5030353490,5030389737,5030395567,5030395563,5030405537,5030407818,5030408128,5030247737,5030248313,5030361895,5030259011,5030259014,5030259676,5030264017,5030280301,5030280389,5030348695,5030373423,5030380784,5030301033,5030274636,5030330287,5030368331,5030269282,5030337464,5030341813,5030380544,5030388330,3050024955,5030278052,5030278053,5030280144,5030280141,5030280394,5030280716,5030287401,5030274578,5030274577,5030310879,5030310915,5030274617,5030274595,5030274580,5030316609,5030303086,5030303085,5030303082,5030303078,50303030126,5030303125,5030303795,5030311211,5030344732,5030375217,5030392318,5030392546,5030295789,5030334567,5030347050,5030323269,5030328170,5030328961,5030349935,5030350991,5030303864,5030304364,5030304360,5030346549,5030385038,5030163141,5030305792,5030367167,5030410610,5030312101,5030346169,5030357884,5030376158,5030383342,5030383894,5030410609,5030314020,5030323421,5030317259,5030318490,5030318177,5030323267,5030325760,5030326067,5030330500,5030374365,5030332640,5030338932,SDNO12390215,5030341815,5030395602,5030255715,5030341422,5030346178,5030347010,5030036143,5030349613,5030349934,5030353232,5030362641,5030362637,5030356084,5030361847,5030397203,5030373321,5030373314,5030393725,5030396427,5030410674,5030373385,5030390045,5030390043,5030390698,5030409276,5030409275,5030409268"}
];

const MapController: React.FC = () => {
  const map = useMap();
  const { mapView } = useOltStore();

  useEffect(() => {
    map.flyTo(mapView.center, mapView.zoom, {
      duration: 1.5,
      easeLinearity: 0.25,
    });
  }, [mapView, map]);

  return null;
};

const App: React.FC = () => {
  const { setAllOlts, allOlts, mapView } = useOltStore();

  useEffect(() => {
    const init = async () => {
      const processed = await dataService.initializeData(RAW_OLT_DATA as any[]);
      setAllOlts(processed);
    };
    init();
  }, [setAllOlts]);

  return (
    <div className="h-screen w-full relative">
      <MapContainer
        center={mapView.center}
        zoom={mapView.zoom}
        zoomControl={false} // Custom zoom position or hide for clean UI
        className="h-full w-full z-0"
      >
        <MapController />
        <TileLayer
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
        />

        <MarkerClusterGroup
          chunkedLoading
          maxClusterRadius={40}
          showCoverageOnHover={false}
          spiderfyOnMaxZoom={true}
        >
          {allOlts.map((olt) => (
            <OLTMarker key={olt.id} olt={olt} />
          ))}
        </MarkerClusterGroup>
      </MapContainer>

      <SearchPanel />

      {/* Region Tag */}
      <div className="absolute top-4 right-4 z-[1000] hidden md:block">
        <div className="bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-lg border border-blue-100 flex items-center gap-2">
            <div className="w-3 h-3 bg-blue-600 rounded-full animate-pulse"></div>
            <span className="text-xs font-bold text-blue-900 uppercase tracking-widest">Southern Region (TH)</span>
        </div>
      </div>
    </div>
  );
};

export default App;
